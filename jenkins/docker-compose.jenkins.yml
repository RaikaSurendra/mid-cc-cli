# =============================================================================
# Jenkins Local Development Environment
# =============================================================================
# Runs Jenkins LTS with Docker-in-Docker support for learning and testing
# the mid-llm-cli CI/CD pipeline locally.
#
# Usage:
#   cd jenkins/
#   docker compose -f docker-compose.jenkins.yml up -d
#   open http://localhost:8080
#
# First-time setup:
#   docker exec jenkins-local cat /var/jenkins_home/secrets/initialAdminPassword
# =============================================================================

services:
  jenkins:
    image: jenkins/jenkins:lts-jdk17
    container_name: jenkins-local
    restart: unless-stopped
    ports:
      - "8080:8080"     # Jenkins web UI
      - "50000:50000"   # Jenkins agent connections
    volumes:
      # Persist Jenkins configuration, jobs, and plugins across restarts
      - jenkins_home:/var/jenkins_home
      # Mount Docker socket so Jenkins can run Docker commands on the host
      - /var/run/docker.sock:/var/run/docker.sock
      # Pre-load the plugin list
      - ./plugins.txt:/usr/share/jenkins/ref/plugins.txt
    environment:
      # Install plugins from plugins.txt on first boot
      JAVA_OPTS: >-
        -Djenkins.install.runSetupWizard=true
        -Xmx2g
        -Xms512m
      # Skip the "unlock Jenkins" step in subsequent boots
      JENKINS_OPTS: "--httpPort=8080"
    # Run as root so we can install Docker CLI inside the container
    user: root
    # Install Docker CLI inside Jenkins so pipeline steps can call docker
    entrypoint: >
      bash -c "
        apt-get update && apt-get install -y docker.io &&
        chown -R 1000:1000 /var/jenkins_home &&
        su - jenkins -c '/usr/local/bin/jenkins.sh'
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/login"]
      interval: 30s
      timeout: 10s
      start_period: 120s
      retries: 5

  # Docker-in-Docker sidecar (alternative to socket mounting)
  # Uncomment this if you prefer full isolation instead of sharing the host daemon.
  # dind:
  #   image: docker:dind
  #   container_name: jenkins-dind
  #   privileged: true
  #   restart: unless-stopped
  #   environment:
  #     DOCKER_TLS_CERTDIR: /certs
  #   volumes:
  #     - docker-certs-ca:/certs/ca
  #     - docker-certs-client:/certs/client
  #     - jenkins_home:/var/jenkins_home
  #   networks:
  #     - jenkins-net

volumes:
  jenkins_home:
    name: mid-llm-cli-jenkins-home
  # docker-certs-ca:
  # docker-certs-client:
