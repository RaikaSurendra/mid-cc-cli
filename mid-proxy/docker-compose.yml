# =============================================================================
# MID Proxy Stack — Claude Terminal Service + MID Server
# =============================================================================
# Alternative to the ECC Poller approach. Uses ServiceNow MID Server's native
# JavascriptProbe framework to relay commands instead of custom Go polling.
#
# Usage:
#   docker compose -f mid-proxy/docker-compose.yml up -d
#
# Architecture:
#   ServiceNow Instance
#     → ECC Queue (JavascriptProbe)
#       → MID Server (ClaudeTerminalProbe.js)
#         → HTTP → claude-terminal-service:3000
#           → PTY session (Claude Code CLI)
#
# Compared to ECC Poller:
#   - Eliminates the custom Go poller binary
#   - Uses MID Server's native probe pickup (~2s vs 5s polling)
#   - 3 services instead of 4
# =============================================================================

services:
  # PostgreSQL — session persistence
  postgres:
    image: postgres:16-alpine
    container_name: mid-proxy-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: claude_terminal
      POSTGRES_USER: claude
      POSTGRES_PASSWORD: claude_dev_password
    ports:
      - "5433:5432"
    volumes:
      - mid_proxy_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U claude -d claude_terminal"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Claude Terminal HTTP Service — same binary, no changes needed
  claude-terminal-service:
    build:
      context: ..
      dockerfile: Dockerfile
    container_name: mid-proxy-terminal-service
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      SERVER_HOST: "0.0.0.0"
      SERVER_PORT: "3000"
      API_AUTH_TOKEN: "${API_AUTH_TOKEN:-dev-token-change-me}"
      ENCRYPTION_KEY: "${ENCRYPTION_KEY:-0123456789abcdef0123456789abcdef}"
      DATABASE_URL: "postgres://claude:claude_dev_password@postgres:5432/claude_terminal?sslmode=disable"
      LOG_LEVEL: "debug"
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3000/health"]
      interval: 15s
      timeout: 5s
      start_period: 10s
      retries: 3

  # ServiceNow MID Server — picks up JavascriptProbes from ECC Queue
  # and executes ClaudeTerminalProbe.js which calls claude-terminal-service
  servicenow-mid-server:
    image: servicenow/mid:latest
    container_name: mid-proxy-mid-server
    restart: unless-stopped
    depends_on:
      claude-terminal-service:
        condition: service_healthy
    environment:
      # ServiceNow instance connection
      SN_INSTANCE_URL: "${SN_INSTANCE_URL:-https://your-instance.service-now.com}"
      SN_USERNAME: "${SN_USERNAME:-mid.user}"
      SN_PASSWORD: "${SN_PASSWORD}"
      MID_SERVER_NAME: "${MID_SERVER_NAME:-mid-docker-proxy}"
      # MID Server config
      SN_MID_MUTUAL_AUTH: "false"
    volumes:
      - mid_proxy_middata:/opt/servicenow/mid/agent
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/status || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 120s
      retries: 5

volumes:
  mid_proxy_pgdata:
    name: mid-proxy-pgdata
  mid_proxy_middata:
    name: mid-proxy-middata
